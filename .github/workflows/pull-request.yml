name: Pull Request

on:
  pull_request:
    branches: [master]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:run

      - name: Generate coverage report
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: unit-tests
          fail_ci_if_error: false

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium browser
        run: npx playwright install chromium --with-deps

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          CI: true
          BASE_URL: http://localhost:3000
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_KEY }}
          E2E_USERNAME_ID_ADMIN: ${{ secrets.E2E_USERNAME_ID_ADMIN }}
          E2E_USERNAME_ADMIN: ${{ secrets.E2E_USERNAME_ADMIN }}
          E2E_USERNAME_ID_TRAINER: ${{ secrets.E2E_USERNAME_ID_TRAINER }}
          E2E_USERNAME_TRAINER: ${{ secrets.E2E_USERNAME_TRAINER }}
          E2E_USERNAME_ID_CLIENT: ${{ secrets.E2E_USERNAME_ID_CLIENT }}
          E2E_USERNAME_CLIENT: ${{ secrets.E2E_USERNAME_CLIENT }}
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          SENDGRID_FROM_EMAIL: ${{ secrets.SENDGRID_FROM_EMAIL }}
          SENDGRID_TEMPLATE_ACTIVATION: ${{ secrets.SENDGRID_TEMPLATE_ACTIVATION }}

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: test-videos
          path: test-results/
          retention-days: 7

  comment-status:
    name: Comment Test Results
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, e2e-tests]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Post test results comment
        uses: actions/github-script@v8
        with:
          script: |
            const lintStatus = '${{ needs.lint.result }}';
            const unitTestsStatus = '${{ needs.unit-tests.result }}';
            const e2eTestsStatus = '${{ needs.e2e-tests.result }}';

            const statusEmoji = (status) => {
              if (status === 'success') return '✅';
              if (status === 'failure') return '❌';
              if (status === 'cancelled') return '⏸️';
              return '⚠️';
            };

            const statusText = (status) => {
              if (status === 'success') return 'Passed';
              if (status === 'failure') return 'Failed';
              if (status === 'cancelled') return 'Cancelled';
              return 'Skipped';
            };

            const allPassed = lintStatus === 'success' && 
                             unitTestsStatus === 'success' && 
                             e2eTestsStatus === 'success';

            const comment = `## ${allPassed ? '✅' : '❌'} Test Results

            | Test Suite | Status |
            |------------|--------|
            | Lint | ${statusEmoji(lintStatus)} ${statusText(lintStatus)} |
            | Unit Tests | ${statusEmoji(unitTestsStatus)} ${statusText(unitTestsStatus)} |
            | E2E Tests | ${statusEmoji(e2eTestsStatus)} ${statusText(e2eTestsStatus)} |

            ${allPassed ? '**All checks passed!** ✨' : '**Some checks failed.** Please review the workflow logs for details.'}

            ---
            *Workflow run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-output-pr-${{ github.event.pull_request.number }}
          path: dist/
          retention-days: 3
