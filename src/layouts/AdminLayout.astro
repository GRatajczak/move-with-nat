---
import Layout from "./Layout.astro";
import { MainLayout } from "./MainLayout";
import { Toaster } from "../components/ui/sonner";
import type { AuthenticatedUser } from "@/types";

interface Props {
  title?: string;
}

const { title = "Admin Dashboard" } = Astro.props;

// Get user from context (set by middleware)
const user = Astro.locals.user as AuthenticatedUser;
const supabase = Astro.locals.supabase;

// If no user, redirect to login
if (!user || !supabase) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
if (user.role !== "admin") {
  return Astro.redirect(`/${user.role}`);
}

const { data: userDetails } = await supabase.from("users").select("first_name, last_name").eq("id", user.id).single();

// Get current path
const currentPath = Astro.url.pathname;

// Mock user data for now (will be replaced with actual user data from auth)
const fullUser = {
  id: user.id,
  email: user.email,
  firstName: userDetails?.first_name || "Admin",
  lastName: userDetails?.last_name || "User",
  role: user.role,
};
---

<Layout title={title}>
  <MainLayout client:only="react" user={fullUser} currentPath={currentPath} requiredRole="admin">
    <slot />
  </MainLayout>
  <Toaster client:only="react" />
</Layout>
